<!DOCTYPE html>
<html lang="en">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      extensions: [
        "MathMenu.js",
        "MathZoom.js",
        "AssistiveMML.js",
        "a11y/accessibility-menu.js"
      ],
      jax: ["input/TeX", "output/CommonHTML"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      TeX: {
        extensions: [
          "AMSmath.js",
          "AMSsymbols.js",
          "noErrors.js",
          "noUndefined.js",
        ]
      }
    });
    
  </script>

  \(
\newcommand{\de}[0]{\mathrm{d}}
\newcommand{\del}[0]{\partial}
\newcommand{\delz}[0]{\partial_z}
\newcommand{\delx}[0]{\partial_x}
\newcommand{\delbar}[0]{\Bar{\partial}}
\newcommand{\delbarz}[0]{\partial_{\bar{z}}}
\newcommand{\zbar}[0]}
\newcommand{\hath}[0]
\newcommand{\hatL}[0]
\newcommand{\de}[0]{\textrm{d}}
\newcommand{\Jac}[0]{\textrm{Jac}}
\newcommand{\Tot}[0]{\textrm{Tot}}
\newcommand{\sub}[0]{\subset}
\newcommand{\Tr}[0]{\textrm{Tr}}
\newcommand{\Aut}[0]{\mathrm{Aut}}
\newcommand{\End}[0]{\mathrm{End}}
\newcommand{\irr}[0]{\mathrm{irr}}
\newcommand{\Hom}[0]{\mathrm{Hom}}
\newcommand{\Sym}[0]{\mathrm{Sym}}
\newcommand{\Res}[0]{\mathrm{Res}}
\newcommand{\rank}[0]{\mathrm{rank}}
\newcommand{\reg}[0]{\mathrm{reg}}
\newcommand{\floor}[1]{\left \lfloor{#1}\right \rfloor}
\newcommand{\vectwo}[2]{\begin{pmatrix} #1 \\ #2 \end{pmatrix}}
\newcommand{\bv}[0]{\mathbf{v}}
\newcommand{\inv}[0]{^{-1}}
\newcommand{\higgs}[0]{ {\textrm{higgs }}}
\newcommand{\ts}{\textsuperscript}
\newcommand{\Mtoy}[0]{ \calM^{\textrm{toy }}}
\newcommand{\Mell}[0]{ \calM^{\textrm{ell }}}
\newcommand{\bloch}[0]{\beta}
\newcommand{\HH}[0]{\mathbb{H}}
\newcommand{\calH}[0]{\mathcal{H}}
\newcommand{\calM}[0]{\mathcal{M}}
\newcommand{\calP}[0]{\mathcal{P}}
\newcommand{\calL}[0]{\mathcal{L}}
\newcommand{\calN}[0]{\mathcal{N}}
\newcommand{\calB}[0]{\mathcal{B}}
\newcommand{\calI}[0]{\mathcal{I}}
\newcommand{\calE}[0]{\mathcal{E}}
\newcommand{\calO}[0]{\mathcal{O}}
\newcommand{\RR}[0]{\mathbb{R}}
\newcommand{\CC}[0]{\mathbb{C}}
\newcommand{\ZZ}[0]{\mathbb{Z}}
\newcommand{\PP}[0]{\mathbb{P}}
\)

  <head>
  <meta charset="UTF-8">

  <link rel="canonical" href="/toric-geometry/math-848-project/6-semiclassical-properties-of-moment-maps/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description" content="Semiclassical properties of moment maps: The Duistermaat-Heckman theorem">

  <meta property="og:site_name" content="My digital garden">

  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">

  <link rel="stylesheet" href="/styles.css">



  
  <meta property="og:description" content="Semiclassical properties of moment maps: The Duistermaat-Heckman theorem"/>
  

  
  <meta property="og:title" content="6 semiclassical properties of moment maps">
  <meta property="og:type" content="article">
  

  
  <meta property="article:published_time" content="2022-05-14T14:07:59-04:00">
  <meta property="article:author" content="/">
  

  <meta property="og:url" content="/toric-geometry/math-848-project/6-semiclassical-properties-of-moment-maps/" />

  

  <title>
    
      6 semiclassical properties of moment maps &mdash; My digital garden
    
  </title>
</head>

  <body>
    <nav><div>
    <a class="internal-link" href="/"><b>My digital garden</b></a>
</div>
</nav>
    <div class="wrapper">
      <main><article>
  <div>
    <h1>6 semiclassical properties of moment maps</h1>
    <time datetime="2022-05-13T16:25:54-04:00">
      Last updated on May 13, 2022
      
    </time>
  </div>

  <div id="notes-entry-container">
    <content>
      <pre><code class="language-toc">
</code></pre>
<h1 id="semiclassical-properties-of-moment-maps-the-duistermaat-heckman-theorem">Semiclassical properties of moment maps: The Duistermaat-Heckman theorem</h1>

<p>So far we have seen some of the superpowers of torus actions, framing their moment maps as a global versions of a harmonic oscillators. Moment maps inherit some special properties from harmonic oscillators, which are seemingly independent of their associated $U(1)$ action. As usual this comes from physics, and specifically the border between classical and quantum mechanics. Suppose that we’re interested in stationary states of a system. In classical mechanics, a state is a point on a symplectic manifold $M$ evolving under a Hamiltonian flow, and it is stationary when it sits at one of the Hamiltonian’s critical points. Quantum mechanics promotes states from points to complex valued functions, meaning the quantum properties include contributions from all points, not just the classically fixed ones. In the so-called path integral formulation, this data is all encoded in a single <em>partition function</em>
\(Z(t) = \int_M \exp{i t H}\)</p>

<p>The parameter $t$ controls the strength of quantum mechanical effects, so is often denoted by $1/\hbar$. As $t$ becomes very large the integrand oscillates extremely quickly away from fixed points of $H$. The rapid oscillations cancel each other out, so integrals’ value is primarily controlled by the fixed points. This is formally encoded in the \textit{Stationary phase approximation}, which aymptotically expands the integral in orders of $1/t$ using fixed points of $H$. (We will more carefully describe this momentarily). Physically this represents a sort of semiclassical limit, and the integral depends only on fixed points because quantum states concentrate towards classical states as $\hbar$ goes to zero. For harmonic oscillators, semiclassical expansions stop after first order. That is, the semiclassical limit is <em>exact</em>. Now, given my repeated insistence that $U(1)$ moment maps are global versions of harmonic osscilators, you might have guessed:
==Include picture==</p>

<blockquote>
  <p>[!Theorem]+ [[Toric geometry/Duistermaat-Heckman theorem|Duistermaat-Heckman theorem]]
The stationary phase approximation is exact for $U(1)$ moment maps</p>
</blockquote>

<p>In physics you run into a potpourri of examples when the semiclassical approximation is no approximation: The harmonic osscilator, the free particle, a particle in a constant field, etc. It seems like these are just simple examples where we happen to get lucky, but Duistermaat-Heckman (DH) shows the underlying reason: A shared $U(1)$ symmetry. In fact, DH is a just a small manifestation of a rich underlying structure called <em>equivariant cohomology</em>, which naturally extends cohomology to spaces with group actions.</p>

<p>There are two routes to prove the Duistermaat-Heckman theorem. The first, used by the namesake \addCite{DH}, provides a simple form for symplectic form on a symplectic reduction as the offset of the moment map varies. The stationary phase approximation falls out as a corollary. The second approach uses equivariant cohomology. The DH theorem is a specific case of a very general localization formulae, which describes equivariant cohomology classes through the fixed points of a group action. Both proofs involve structures which are interesting in their own right, and their methods illuminate one another. We will follow Duistermaat and Heckman’s original proof in this section, and see a taste of equivariant cohomology in the next.</p>

<h2 id="variation-of-symplectic-stuctures">Variation of symplectic stuctures</h2>

<p>Say a symplectic manifold $M$ carries a $G$-action with moment map $\mu: M \to \frak{g}^*$. Recall the definition of the symplectic reduction:</p>

\[M_0 = M // G = \mu\inv(0)/G\]

<p>Which is a manifold when $0$ is a regular value of the moment map, so that $G$ acts freely on $\mu\inv(0)$. The choice of 0 here is ultimatley arbitrary: We could have chosen any regular value $t \in \frak{g}^*$, obtaining the symplectic manifold
\(M_t  \equiv \mu\inv(t)/G\)
But how does $M_t$ depend on $t$? For inspiration, let’s look to our new friends, the toric manifolds.</p>

<blockquote>
  <p>[!example]+ 
Consider $\PP^2$, described in example ==link example==, whose moment polytope shown in figure ==add figure==. This has a $U(1)^2$ action generated by the Hamiltonians which are projection $\pi_x$ onto the $x$ axis and $\pi_y$ onto $y$. Consider the $U(1)$ action generated by $\pi_x$, and its symplectic reduction $\PP^2_t = \pi_x\inv(t)/U(1)$ for $t\in (0,1)$. This manifold is still toric, from the residual action of $\pi_y$. Indeed, $\pi_y$ is a function on $\pi_x\inv(t)$, which is invariant on the orbits generated by $\pi_x$ since the two Hamiltonians commute. So, $\pi_y$ descends to $\PP^2_t$. The associated moment map is the slice of the polytope for $\PP^2$ defined by $\pi_x = t$, which is a line segment of length $\ell(t)$. By the delzant correspondence, we know the symplectic reduction: The line becomes a sphere, with form proportial to the line’s length
\(\PP^2_t = (S,\ell(t) \omega_{FS})\)
From the diagram, we can see $\ell(t) = 1-t$. In particular, this is \textit{linear} with the value of the moment map. We get something similar for any Hamiltonian coming from $\pi_x$ and $\pi_y$. Figure ==add figure== depicts projecting onto some generic 1-dimensional subspace of ${\frak{u}(1)^2}^*$, and we see that the length of slices first grows linearly, then shrinks linearly.</p>
</blockquote>

<p>At least intuitivly, this generalizes to any toric manifold. For a Hamiltonian projecting the moment polytope onto a dimension one subspace, the slices are all polytopes whose sides vary linearly with the Hamiltonian. The symplectic form is piecewise linear, with discontinuities at critical points of the Hamiltonian (when the slice hits a vertex of the polytope).</p>

<p>This intuition almost carries us to the general case. In fact, an arbitrary $U(1)$ action has a symplectic form which is linear <em>in cohomology</em></p>

<div class="transclusion internal-embed is-loaded"><div class="markdown-embed">

<div class="markdown-embed-title">



</div>

#theorem 


Let $(\calP,\omega)$ be a 2m-dimensional symplectic manifold, with $U(1)^n$ action defined by [[Toric geometry/Moment map|Moment map]]$\mu:\calP \to \mathfrak{t}^*\equiv {\mathfrak{u}(1)^{n}}^*$.  [[Toric geometry/Symplectic reduction|Symplectic reduction]] yields a family of symplectic manifolds parametrized by the level of the moment map $t\in \mathfrak{t}^*$:

$(\calP_{t},\omega_{t} ) = \mu\inv(t)/U(1)^n$


&gt;[!theorem] Theorem: Duistermaat-Heckman, version 1
&gt;The cohomology class  $[\omega_t]$ depends piecewise linearly on $t$. More precisely, for $t$ in a neighborhood of a regular value $t_0$, The manifolds $\calP_{t}$ and $\calP_{t_0}$ are diffeomorphic, and there is a fixed element $c\in H_2(\calP_{t_0},\mathfrak{t})$ such that
&gt;$[\omega_{t}] = [\omega_0] + \langle t-t_{0},c\rangle $
^thm--DH-v1

&gt;[!proof]+ 
&gt;Follows from normal form of $U(1)^n$ actions. Since $t_0$ is regular, $\mu\inv(t_0)$ is a $U(1)^{n}$ principal bundle $P \to \calP$. For a neighborhood of regular values $U$, $\mu\inv(U)$ is a subset of $P \times \mathfrak{t}^*$. This carries a natural symplectic form 
&gt;$\omega' =  \pi^{*}\omega_{0}+\langle t,F_t \rangle$
&gt;where $F$ is the curvature of $P$ as a $\mathfrak{t}$-valued 2-form. This implies
&gt;$\frac{\de}{\mathrm{d} t}\omega_t =  F_t $
&gt;The cohomology of $F$ is constant, constrained topologically to equal the first Chern class $c$.  So, the derivative of $\omega_t$ is constant, meaning $\omega_t$ is linear in $t$.



&gt;[!theorem]+ Thoemrem: Duistermaat-Heckmann, version 2
&gt;The pushforward of the symplectic volume of $\calP$ under the moment map is a piecewise polynomial measure on $\mathfrak{t}$. 
^thm--DH-v2

&gt;[!proof]+
&gt;The pushforward of the symplectic volume is $f \prod \mathrm{d}t_i$ for a function $f(t) = \mathrm{Vol}(\calP_t)$. The dimension of $\calP_t$ is $2(n-m)$, so its volume is measured cohomologically by the class $[\omega_t]^{(m-n)}$. Since $[\omega_t]$ is piecewise linear, $\mathrm{Vol}(\calP_t)$ is a piecewise degree $(m-n)$ polynomial


&gt;[!theorem]+ Theorem: Duistermaat-Heckman, version 3
&gt;For a Hamiltonian $H$ generating a $U(1)$ action, the stationary phase approximation is *exact* for the Integral
 &gt; $\int_M e^{i t H}$
 &gt;That is, the integral localizes to the sum of gaussian integrals at the fixed points. This yields the Duistermaat-Heckman formula
 &gt;$\int_{M}e^{i t H} = \sum_{p \in F} \frac{e^{it H(p)}}{\sqrt{\mathrm{Det}(D^{2}H(p))}}$

&gt;[!proof]+ Proof 1
&gt;Quickly follows from [[Toric geometry/Duistermaat-Heckman theorem#^thm--DH-v2|Duistermaat-Heckman theorem#^thm--DH-v2]]. Need to verify this equality holds for integrals over the moment map part, and the complement. The complement is locally exactly quadratic by [[Toric geometry/Equivariant Darboux's theorem|Equivariant Darboux's theorem]], so stationary phase is exact.  the moment map part is exact because Fourier transforms of polynomials is a sum of Dirac deltas and their derivatives, whose contribution must vanish by smoothness. 

 &gt;[!proof]+ Proof 2
 &gt;Follows from the localization formula in equivariant cohomology. The $U(1)$-equivariant extension of the symplectic form is 
 &gt;$\omega^{\sharp}= \omega + itH$
 &gt;Using this,
 &gt;$\int_{M}\omega^{n}e^{i t H}=\int_{M}e^{\omega^\sharp} $
 &gt;$e^{\omega^\sharp}$ is an equivariant cohomology class, so its integral localizes to $U(1)$ fixed points, and the formula retrieves the leading order stationary phase approximation.

</div></div>

<p>Note that we’re identifying the manifold underlying $M_t$ with $M_0$. This comes from Morse theory, as $M_0$ and $M_t$ are quotients of level sets of the same function, and there are no critical points between $0$ and $t$ to change their topology.</p>

<table>
  <tbody>
    <tr>
      <td>Like many other symplectic geometry constructions, theorem [[Toric geometry/Duistermaat-Heckman theorem</td>
      <td>Duistermaat-Heckman theorem]] comes from a normal form construction. We will eventually identify a part of $M$ with no critical points with a complex line bundle over $M_t$. But to inform the math approach, let’s instead start thinking physically.</td>
    </tr>
  </tbody>
</table>

<h2 id="intermission-symmetries-of-electromagnetism">Intermission: Symmetries of Electromagnetism</h2>

<p>This section is somewhat of a digression from the primary plotline, but I can’t resist mentioning.</p>

<p>\subsection{Symplectic structures on space of orbits}
Normal form: Describe using line bundles, electromagentism</p>


    </content>

    <side style="font-size: 0.9em">
      <h3 style="margin-bottom: 1em">Notes mentioning this note</h3>
      

      <div style="font-size: 0.9em">
        <p>
          There are no notes linking to this note.
        </p>
      </div>
      
    </side>
  </div>
</article>

<hr>

<p>Here are all the notes in this garden, along with their links, visualized as a graph.</p>

<style>
  .links line {
    stroke: #ccc;
    opacity: 0.5;
  }

  .nodes circle {
    cursor: pointer;
    fill: #8b88e6;
    transition: all 0.15s ease-out;
  }

  .text text {
    cursor: pointer;
    fill: #333;
    text-shadow: -1px -1px 0 #fafafabb, 1px -1px 0 #fafafabb, -1px 1px 0 #fafafabb, 1px 1px 0 #fafafabb;
  }

  .nodes [active],
  .text [active] {
    cursor: pointer;
    fill: black;
  }

  .inactive {
    opacity: 0.1;
    transition: all 0.15s ease-out;
  }

  #graph-wrapper {
    background: #fcfcfc;
    border-radius: 4px;
    height: auto;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"
  integrity="sha512-FHsFVKQ/T1KWJDGSbrUhTJyS1ph3eRrxI228ND0EGaEp6v4a/vGwPWd3Dtd/+9cI7ccofZvl/wulICEurHN1pg=="
  crossorigin="anonymous"></script>

<div id="graph-wrapper">
  <script>
    const MINIMAL_NODE_SIZE = 8;
    const MAX_NODE_SIZE = 12;
    const ACTIVE_RADIUS_FACTOR = 1.5;
    const STROKE = 1;
    const FONT_SIZE = 16;
    const TICKS = 200;
    const FONT_BASELINE = 40;
    const MAX_LABEL_LENGTH = 50;

    const graphData = {"edges":[{"source":"891111171143210210511411511632115101101100","target":"6532110111116101329798111117116329997116115"},{"source":"891111171143210210511411511632115101101100","target":"84105103101114115"},{"source":"77111118101321211111171143298111100121321011181011141213210097121","target":"67111110115105115116101110991213210511532107101121"},{"source":"6532110111116101329798111117116329997116115","target":"77111118101321211111171143298111100121321011181011141213210097121"},{"source":"6911311710511897114105971101163210097114981111171203911532116104101111114101109","target":"6897114981111171203911532116104101111114101109"},{"source":"5032973211211410510910111432111110321031011111091011161141059932109101991049711010599115","target":"6897114981111171203911532116104101111114101109"},{"source":"5432115101109105991089711511510599971083211211411111210111411610510111532111102321091111091011101163210997112115","target":"6811710511511610111410997971163272101991071099711032116104101111114101109"},{"source":"6811710511511610111410997971163272101991071099711032116104101111114101109","target":"6911311710511897114105971101163210097114981111171203911532116104101111114101109"},{"source":"51321161041013210310111110910111611412132111102321049711410911111010599321111159910510810897116111114115","target":"6911311710511897114105971101163210097114981111171203911532116104101111114101109"},{"source":"67112110","target":"771111091011101163210997112"},{"source":"6811710511511610111410997971163272101991071099711032116104101111114101109","target":"771111091011101163210997112"},{"source":"51321161041013210310111110910111611412132111102321049711410911111010599321111159910510810897116111114115","target":"771111091011101163210997112"},{"source":"8312110911210810199116105993211410110011799116105111110","target":"771111091011101163210997112"},{"source":"67112110","target":"8312110911210810199116105993211410110011799116105111110"},{"source":"6811710511511610111410997971163272101991071099711032116104101111114101109","target":"8312110911210810199116105993211410110011799116105111110"},{"source":"51321161041013210310111110910111611412132111102321049711410911111010599321111159910510810897116111114115","target":"8312110911210810199116105993211410110011799116105111110"},{"source":"67111110115105115116101110991213210511532107101121","target":"891111171143210210511411511632115101101100"},{"source":"891111171143210210511411511632115101101100","target":"891111171143210210511411511632115101101100"},{"source":"891111171143210210511411511632115101101100","target":"236149136235133149237149152236132184236154148"}],"nodes":[{"id":"6532110111116101329798111117116329997116115","path":"/cats","label":"A note about cats"},{"id":"84105103101114115","path":"/tigers","label":"Tigers"},{"id":"67111110115105115116101110991213210511532107101121","path":"/consistency","label":"Consistency is key"},{"id":"77111118101321211111171143298111100121321011181011141213210097121","path":"/move-your-body-every-day","label":"Move your body every day"},{"id":"84101115116","path":"/test","label":"Test"},{"id":"67112110","path":"/cpn","label":"Cpn"},{"id":"6897114981111171203911532116104101111114101109","path":"/darboux-s-theorem","label":"Darboux's theorem"},{"id":"6811710511511610111410997971163272101991071099711032116104101111114101109","path":"/duistermaat-heckman-theorem","label":"Duistermaat Heckman theorem"},{"id":"6911311710511897114105971101163210097114981111171203911532116104101111114101109","path":"/equivariant-darboux-s-theorem","label":"Equivariant darboux's theorem"},{"id":"48321169798108101321111023299111110116101110116115","path":"/0-table-of-contents","label":"0 table of contents"},{"id":"493210511011611411110011799116105111110","path":"/1-introduction","label":"1 introduction"},{"id":"5032973211211410510910111432111110321031011111091011161141059932109101991049711010599115","path":"/2-a-primer-on-geometric-mechanics","label":"2 a primer on geometric mechanics"},{"id":"51321161041013210310111110910111611412132111102321049711410911111010599321111159910510810897116111114115","path":"/3-the-geometry-of-harmonic-oscillators","label":"3 the geometry of harmonic oscillators"},{"id":"5332116111114105993210997110105102111108100115","path":"/5-toric-manifolds","label":"5 toric manifolds"},{"id":"5432115101109105991089711511510599971083211211411111210111411610510111532111102321091111091011101163210997112115","path":"/6-semiclassical-properties-of-moment-maps","label":"6 semiclassical properties of moment maps"},{"id":"553210111311710511897114105971101163299111104111109111108111103121","path":"/7-equivariant-cohomology","label":"7 equivariant cohomology"},{"id":"771111091011101163210997112","path":"/moment-map","label":"Moment map"},{"id":"8312110911210810199116105993211410110011799116105111110","path":"/symplectic-reduction","label":"Symplectic reduction"},{"id":"73110116114111","path":"/intro","label":"Intro"},{"id":"891111171143210210511411511632115101101100","path":"/your-first-note","label":"Your first seed"},{"id":"236149136235133149237149152236132184236154148","path":"/%EC%95%88%EB%85%95%ED%95%98%EC%84%B8%EC%9A%94","label":"안녕하세요"}]}
    let nodesData = graphData.nodes;
    let linksData = graphData.edges;

    const nodeSize = {};

    const updateNodeSize = () => {
      nodesData.forEach((el) => {
        let weight =
          3 *
          Math.sqrt(
            linksData.filter((l) => l.source.id === el.id || l.target.id === el.id)
              .length + 1
          );
        if (weight < MINIMAL_NODE_SIZE) {
          weight = MINIMAL_NODE_SIZE;
        } else if (weight > MAX_NODE_SIZE) {
          weight = MAX_NODE_SIZE;
        }
        nodeSize[el.id] = weight;
      });
    };

    const onClick = (d) => {
      window.location = d.path
    };

    const onMouseover = function (d) {
      const relatedNodesSet = new Set();
      linksData
        .filter((n) => n.target.id == d.id || n.source.id == d.id)
        .forEach((n) => {
          relatedNodesSet.add(n.target.id);
          relatedNodesSet.add(n.source.id);
        });

      node.attr("class", (node_d) => {
        if (node_d.id !== d.id && !relatedNodesSet.has(node_d.id)) {
          return "inactive";
        }
        return "";
      });

      link.attr("class", (link_d) => {
        if (link_d.source.id !== d.id && link_d.target.id !== d.id) {
          return "inactive";
        }
        return "";
      });

      link.attr("stroke-width", (link_d) => {
        if (link_d.source.id === d.id || link_d.target.id === d.id) {
          return STROKE * 4;
        }
        return STROKE;
      });
      text.attr("class", (text_d) => {
        if (text_d.id !== d.id && !relatedNodesSet.has(text_d.id)) {
          return "inactive";
        }
        return "";
      });
    };

    const onMouseout = function (d) {
      node.attr("class", "");
      link.attr("class", "");
      text.attr("class", "");
      link.attr("stroke-width", STROKE);
    };

    const sameNodes = (previous, next) => {
      if (next.length !== previous.length) {
        return false;
      }

      const map = new Map();
      for (const node of previous) {
        map.set(node.id, node.label);
      }

      for (const node of next) {
        const found = map.get(node.id);
        if (!found || found !== node.title) {
          return false;
        }
      }

      return true;
    };

    const sameEdges = (previous, next) => {
      if (next.length !== previous.length) {
        return false;
      }

      const set = new Set();
      for (const edge of previous) {
        set.add(`${edge.source.id}-${edge.target.id}`);
      }

      for (const edge of next) {
        if (!set.has(`${edge.source.id}-${edge.target.id}`)) {
          return false;
        }
      }

      return true;
    };

    const graphWrapper = document.getElementById('graph-wrapper')
    const element = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    element.setAttribute("width", graphWrapper.getBoundingClientRect().width);
    element.setAttribute("height", window.innerHeight * 0.8);
    graphWrapper.appendChild(element);

    const reportWindowSize = () => {
      element.setAttribute("width", window.innerWidth);
      element.setAttribute("height", window.innerHeight);
    };

    window.onresize = reportWindowSize;

    const svg = d3.select("svg");
    const width = Number(svg.attr("width"));
    const height = Number(svg.attr("height"));
    let zoomLevel = 1;

    const simulation = d3
      .forceSimulation(nodesData)
      .force("forceX", d3.forceX().x(width / 2))
      .force("forceY", d3.forceY().y(height / 2))
      .force("charge", d3.forceManyBody())
      .force(
        "link",
        d3
          .forceLink(linksData)
          .id((d) => d.id)
          .distance(70)
      )
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("collision", d3.forceCollide().radius(80))
      .stop();

    const g = svg.append("g");
    let link = g.append("g").attr("class", "links").selectAll(".link");
    let node = g.append("g").attr("class", "nodes").selectAll(".node");
    let text = g.append("g").attr("class", "text").selectAll(".text");

    const resize = () => {
      if (d3.event) {
        const scale = d3.event.transform;
        zoomLevel = scale.k;
        g.attr("transform", scale);
      }

      const zoomOrKeep = (value) => (zoomLevel >= 1 ? value / zoomLevel : value);

      const font = Math.max(Math.round(zoomOrKeep(FONT_SIZE)), 1);

      text.attr("font-size", (d) => font);
      text.attr("y", (d) => d.y - zoomOrKeep(FONT_BASELINE) + 8);
      link.attr("stroke-width", zoomOrKeep(STROKE));
      node.attr("r", (d) => {
        return zoomOrKeep(nodeSize[d.id]);
      });
      svg
        .selectAll("circle")
        .filter((_d, i, nodes) => d3.select(nodes[i]).attr("active"))
        .attr("r", (d) => zoomOrKeep(ACTIVE_RADIUS_FACTOR * nodeSize[d.id]));
    };

    const ticked = () => {
      node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
      text
        .attr("x", (d) => d.x)
        .attr("y", (d) => d.y - (FONT_BASELINE - nodeSize[d.id]) / zoomLevel);
      link
        .attr("x1", (d) => d.source.x)
        .attr("y1", (d) => d.source.y)
        .attr("x2", (d) => d.target.x)
        .attr("y2", (d) => d.target.y);
    };

    const restart = () => {
      updateNodeSize();
      node = node.data(nodesData, (d) => d.id);
      node.exit().remove();
      node = node
        .enter()
        .append("circle")
        .attr("r", (d) => {
          return nodeSize[d.id];
        })
        .on("click", onClick)
        .on("mouseover", onMouseover)
        .on("mouseout", onMouseout)
        .merge(node);

      link = link.data(linksData, (d) => `${d.source.id}-${d.target.id}`);
      link.exit().remove();
      link = link.enter().append("line").attr("stroke-width", STROKE).merge(link);

      text = text.data(nodesData, (d) => d.label);
      text.exit().remove();
      text = text
        .enter()
        .append("text")
        .text((d) => shorten(d.label.replace(/_*/g, ""), MAX_LABEL_LENGTH))
        .attr("font-size", `${FONT_SIZE}px`)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "central")
        .on("click", onClick)
        .on("mouseover", onMouseover)
        .on("mouseout", onMouseout)
        .merge(text);

      node.attr("active", (d) => isCurrentPath(d.path) ? true : null);
      text.attr("active", (d) => isCurrentPath(d.path) ? true : null);

      simulation.nodes(nodesData);
      simulation.force("link").links(linksData);
      simulation.alpha(1).restart();
      simulation.stop();

      for (let i = 0; i < TICKS; i++) {
        simulation.tick();
      }

      ticked();
    };

    const zoomHandler = d3.zoom().scaleExtent([0.2, 3]).on("zoom", resize);

    zoomHandler(svg);
    restart();

    function isCurrentPath(notePath) {
      return window.location.pathname.includes(notePath)
    }

    function shorten(str, maxLen, separator = ' ') {
      if (str.length <= maxLen) return str;
      return str.substr(0, str.lastIndexOf(separator, maxLen)) + '...';
    }
  </script>
</div>

</main>
      <footer>This is the footer. Include anything you'd like here, like a link to an <a class="internal-link" href="/about">About</a> page.
</footer>
    </div>

    <!-- That file is not particularly elegant. This will need a refactor at some point. -->
<style>
  content a.internal-link {
    border-color: #8b88e6;
    background-color: #efefff;
  }

  #tooltip-wrapper {
    background: white;
    padding: 1em;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
    position: absolute;
    width: 400px;
    height: 250px;
    font-size: 0.8em;
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    opacity: 0;
    transition: opacity 100ms;
  }

  #tooltip-wrapper:after {
		content: "";
		position: absolute;
		z-index: 1;
		bottom: 0;
		left: 0;
		pointer-events: none;
		background-image: linear-gradient(to bottom, rgba(255,255,255, 0), rgba(255,255,255, 1) 90%);
		width: 100%;
		height: 75px;
  }
</style>

<div style="opacity: 0; display: none;" id='tooltip-wrapper'>
  <div id='tooltip-content'>
  </div>
</div>

<iframe style="display: none; height: 0; width: 0;" id='link-preview-iframe' src="">
</iframe>

<script>
  var opacityTimeout;
  var contentTimeout;
  var transitionDurationMs = 100;

  var iframe = document.getElementById('link-preview-iframe')
  var tooltipWrapper = document.getElementById('tooltip-wrapper')
  var tooltipContent = document.getElementById('tooltip-content')

  function hideTooltip() {
    opacityTimeout = setTimeout(function() {
      tooltipWrapper.style.opacity = 0;
      contentTimeout = setTimeout(function() {
        tooltipContent.innerHTML = '';
        tooltipWrapper.style.display = 'none';
      }, transitionDurationMs + 1);
    }, transitionDurationMs)
  }

  function showTooltip(event) {
    var elem = event.target;
    var elem_props = elem.getClientRects()[elem.getClientRects().length - 1];
    var top = window.pageYOffset || document.documentElement.scrollTop

    if (event.target.host === window.location.host) {
      iframe.src = event.target.href
      iframe.onload = function() {
        tooltipContentHtml = ''
        tooltipContentHtml += '<div style="font-weight: bold;">' + iframe.contentWindow.document.querySelector('h1').innerHTML + '</div>'
        tooltipContentHtml += iframe.contentWindow.document.querySelector('content').innerHTML

        tooltipContent.innerHTML = tooltipContentHtml

        tooltipWrapper.style.display = 'block';
        setTimeout(function() {
          tooltipWrapper.style.opacity = 1;
        }, 1)
      }

      tooltipWrapper.style.left = elem_props.left - (tooltipWrapper.offsetWidth / 2) + (elem_props.width / 2) + "px";
      if ((window.innerHeight - elem_props.top) < (tooltipWrapper.offsetHeight)) {
          tooltipWrapper.style.top = elem_props.top + top - tooltipWrapper.offsetHeight - 10 + "px";
      } else if ((window.innerHeight - elem_props.top) > (tooltipWrapper.offsetHeight)) {
          tooltipWrapper.style.top = elem_props.top + top + 35 + "px";
      }

      if ((elem_props.left + (elem_props.width / 2)) < (tooltipWrapper.offsetWidth / 2)) {
          tooltipWrapper.style.left = "10px";
      } else if ((document.body.clientWidth - elem_props.left - (elem_props.width / 2)) < (tooltipWrapper.offsetWidth / 2)) {
          tooltipWrapper.style.left = document.body.clientWidth - tooltipWrapper.offsetWidth - 20 + "px";
      }
    }
  }

  function setupListeners(linkElement) {
    linkElement.addEventListener('mouseleave', function(_event) {
      hideTooltip();
    });

    tooltipWrapper.addEventListener('mouseleave', function(_event) {
      hideTooltip();
    });

    linkElement.addEventListener('touchend', function(_event) {
      hideTooltip();
    });

    tooltipWrapper.addEventListener('touchend', function(_event) {
      hideTooltip();
    });

    linkElement.addEventListener('mouseenter', function(event) {
      clearTimeout(opacityTimeout);
      clearTimeout(contentTimeout);
      showTooltip(event);
    });

    tooltipWrapper.addEventListener('mouseenter', function(event) {
      clearTimeout(opacityTimeout);
      clearTimeout(contentTimeout);
    });
  }

  document.querySelectorAll('content a').forEach(setupListeners);
</script>

  </body>
</html>
